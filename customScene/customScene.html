<html>

<head>
    <title>OpenGlobus - Earth planet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://www.openglobus.org/og.css" type="text/css" />
    <script src="http://www.openglobus.org/og.js"></script>
</head>

<body>
    <canvas id="myCanvas" style="width: 100%; height: 80%; display: block"></canvas>
    <div>
        <div style="float:left; padding: 15px;"><input type="checkbox" id="cubeScene" checked>MyScene scene activity</div>
        <div style="float:left; padding: 15px;"><input type="checkbox" id="axisScene" checked>Axis scene activity</div>
    </div>
    <script>
        document.getElementById("cubeScene").onchange = function () {
            renderer.renderNodes.MyScene.setActive(this.checked);
        };
        document.getElementById("axisScene").onchange = function () {
            renderer.renderNodes.Axes.setActive(this.checked);
        };
        //Define custom control class
        var MyScene = function () {
            og.inheritance.base(this, "MyScene");

            this.initialization = function () {

                //Initialize shader program
                this.renderer.handler.addShaderProgram(new og.shaderProgram.ShaderProgram("myShader", {
                    'uniforms': {
                        'uMVMatrix': { type: og.shaderProgram.types.MAT4 },
                        'uPMatrix': { type: og.shaderProgram.types.MAT4 },
                        'uSampler': { type: og.shaderProgram.types.SAMPLER2D }
                    },
                    'attributes': {
                        'aVertexPosition': { type: og.shaderProgram.types.VEC3 },
                        'aTextureCoord': { type: og.shaderProgram.types.VEC2 },
                    },
                    'vertexShader':
                    'attribute vec3 aVertexPosition;\
                            attribute vec2 aTextureCoord;\
                            \
                            uniform mat4 uMVMatrix;\
                            uniform mat4 uPMatrix;\
                            \
                            varying vec2 vTextureCoord;\
                            \
                            void main(void) {\
                                gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);\
                                vTextureCoord = aTextureCoord;\
                            }'
                    ,
                    'fragmentShader':
                    'precision mediump float;\
                            varying vec2 vTextureCoord;\
                            uniform sampler2D uSampler;\
                            \
                            void main(void) {\
                                gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\
                            }'
                }));

                //Load texture                
                this.neheTexture = null;
                var image = new Image();
                var that = this;
                image.onload = function () {
                    that.neheTexture = that.renderer.handler.createTexture_mm(this);
                };
                image.src = "nehe.gif";


                //Create buffers
                var vertices = [
                    // Front face
                    -1.0, -1.0, 1.0,
                    1.0, -1.0, 1.0,
                    1.0, 1.0, 1.0,
                    -1.0, 1.0, 1.0,

                    // Back face
                    -1.0, -1.0, -1.0,
                    -1.0, 1.0, -1.0,
                    1.0, 1.0, -1.0,
                    1.0, -1.0, -1.0,

                    // Top face
                    -1.0, 1.0, -1.0,
                    -1.0, 1.0, 1.0,
                    1.0, 1.0, 1.0,
                    1.0, 1.0, -1.0,

                    // Bottom face
                    -1.0, -1.0, -1.0,
                    1.0, -1.0, -1.0,
                    1.0, -1.0, 1.0,
                    -1.0, -1.0, 1.0,

                    // Right face
                    1.0, -1.0, -1.0,
                    1.0, 1.0, -1.0,
                    1.0, 1.0, 1.0,
                    1.0, -1.0, 1.0,

                    // Left face
                    -1.0, -1.0, -1.0,
                    -1.0, -1.0, 1.0,
                    -1.0, 1.0, 1.0,
                    -1.0, 1.0, -1.0,
                ];

                this.vericesBuffer = this.renderer.handler.createArrayBuffer(new Float32Array(vertices), 3, vertices.length / 3);


                var textureCoords = [
                    // Front face
                    0.0, 0.0,
                    1.0, 0.0,
                    1.0, 1.0,
                    0.0, 1.0,

                    // Back face
                    1.0, 0.0,
                    1.0, 1.0,
                    0.0, 1.0,
                    0.0, 0.0,

                    // Top face
                    0.0, 1.0,
                    0.0, 0.0,
                    1.0, 0.0,
                    1.0, 1.0,

                    // Bottom face
                    1.0, 1.0,
                    0.0, 1.0,
                    0.0, 0.0,
                    1.0, 0.0,

                    // Right face
                    1.0, 0.0,
                    1.0, 1.0,
                    0.0, 1.0,
                    0.0, 0.0,

                    // Left face
                    0.0, 0.0,
                    1.0, 0.0,
                    1.0, 1.0,
                    0.0, 1.0,
                ];

                this.textureCoordsBuffer = this.renderer.handler.createArrayBuffer(new Float32Array(textureCoords), 2, textureCoords.length / 2);


                var cubeVertexIndices = [
                    0, 1, 2, 0, 2, 3,    // Front face
                    4, 5, 6, 4, 6, 7,    // Back face
                    8, 9, 10, 8, 10, 11,  // Top face
                    12, 13, 14, 12, 14, 15, // Bottom face
                    16, 17, 18, 16, 18, 19, // Right face
                    20, 21, 22, 20, 22, 23  // Left face
                ];

                this.indicesBuffer = this.renderer.handler.createElementArrayBuffer(new Uint16Array(cubeVertexIndices), 1, cubeVertexIndices.length);

            };

            var grad = 0;
            this.frame = function () {

                var r = this.renderer;
                var sh = r.handler.shaderPrograms.myShader;
                var p = sh._program;
                var gl = r.handler.gl;

                sh.activate();

                //Cube rotation
                var gradRad = grad * og.math.RADIANS;
                var rotate = og.math.Matrix4.identity()
                    .rotate(og.math.vector3(0, 1, 0), gradRad)
                    .rotate(og.math.vector3(1, 0, 0), gradRad);
                grad++;

                var modelViewMat = r.activeCamera._viewMatrix.mul(rotate);

                //Sets shader's data
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, this.neheTexture);
                gl.uniform1i(p.uniforms.uSampler._pName, 0);

                gl.uniformMatrix4fv(p.uniforms.uMVMatrix._pName, false, modelViewMat._m);
                gl.uniformMatrix4fv(p.uniforms.uPMatrix._pName, false, r.activeCamera._projectionMatrix._m);

                gl.bindBuffer(gl.ARRAY_BUFFER, this.vericesBuffer);
                gl.vertexAttribPointer(p.attributes.aVertexPosition._pName, this.vericesBuffer.itemSize, gl.FLOAT, false, 0, 0);

                gl.bindBuffer(gl.ARRAY_BUFFER, this.textureCoordsBuffer);
                gl.vertexAttribPointer(p.attributes.aTextureCoord._pName, this.textureCoordsBuffer.itemSize, gl.FLOAT, false, 0, 0);

                gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indicesBuffer);
                gl.drawElements(gl.TRIANGLES, this.indicesBuffer.numItems, gl.UNSIGNED_SHORT, 0);
            };
        };

        og.inheritance.extend(MyScene, og.scene.RenderNode);

        var handler = new og.webgl.Handler("myCanvas", { alpha: false });
        handler.initialize();

        var renderer = new og.Renderer(handler);
        renderer.initialize();
        renderer.addRenderNodes([new MyScene(), new og.scene.Axes()]);
        renderer.addControls([
            og.control.simpleNavigation({ 'speed': 0.3 }),
            og.control.showFps()
        ]);
        renderer.activeCamera.set(og.math.vector3(5, 5, 5), og.math.Vector3.ZERO).update();
        renderer.start();
    </script>
</body>

</html>